@page "/"
@using TickTask.Client.Enums
@using TickTask.Client.Services
@using TickTask.Client.Components
@using TickTask.Shared
@inject TimerService timerService
@inject TaskApiService taskService
@inject IJSRuntime JS
@inject ILogger<Index> Logger
@inject HttpClient _httpClient
@inject UserSettingsApiService userSettingsApiService
@inject UserProjectApiService userProjectApiService
@inject TimerStateService TimerState
@implements IDisposable

<PageTitle>
	@(timerType == TimerType.Pomodoro
		? $"🍅 {GetCountdownTimer.RemainingTime}"
		: $"🌴 {GetCountdownTimer.RemainingTime}")
</PageTitle>

<LoginModal @bind-IsOpen="showLogin" />

<div style="background-color:@GetBackgroundColor(); min-height: 100vh; margin: 0">
	<div class="timer-container">
		<div class="timer-header" style="background-color:@GetBackgroundColor();">	
			<!-- Timer Tabs -->
		<div class="timer-tabs">
			@foreach (TimerType type in Enum.GetValues<TimerType>())
			{
				<button class="timer-tab @(timerType == type ? "active" : "")"
						@onclick="() => SelectAndResetTimer(type, userSwitchedTimersUsingTabs : true)">
					@type
					@if (type == TimerType.Pomodoro)
					{
						<span class="pomodoro-count">@NumberOfPomodorosRun/@userSettings.RunsBeforeLongBreak</span>
					}
				</button>
			}
			<button class="control-btn settings-btn" @onclick="OpenSettings">⚙️</button>
		</div>

		<!-- Timer Display -->
		<div class="timer-display">
			<h1 class="timer-time">@($"{(int)GetCountdownTimer.RemainingTime.TotalMinutes:00}:{GetCountdownTimer.RemainingTime.Seconds:00}")</h1>
			@if (GetCountdownTimer.RemainingTime.TotalMinutes + 1 <= GetCountdownTimer.Duration.TotalMinutes)
			{
				<button class="plus-one-btn"
						title="Add one minute to the current timer (not above max duration set in settings)"
						@onclick="() => AddTimeToTimer()">
					+1
				</button>
			}
		</div>

		<!-- Timer Control Buttons -->
		<div class="timer-controls">
			<button class="restart-btn" @onclick="() => RestartTimer(GetCountdownTimer)" title="Restart the current timer">⟲</button>
			<button class="btn-primary timer-main-btn @(GetCountdownTimer.IsRunning ? "running" : "")"
					@onclick="() => ToggleStartStopTimer(timerType, GetCountdownTimer)">
				@(GetCountdownTimer.IsRunning ? "PAUSE" : "START")
			</button>
			<button class="btn-secondary timer-control-btn"
					@onclick="() => HandleTimerFinish(timerWasSkipped : true)"
					title="Skip the current timer">
				→
			</button>
		</div>

		    </div>
		<!-- Task List Component -->
		<TaskList @ref="taskListRef"
				  Settings="userSettings"
				  OnResetPomodoros="ResetPomodoroCount"
				  ActivePomodoro="pomodoroTimer"
				  ActiveShortBreakTimer="shortBreakTimer"
				  ActiveLongBreakTimer="longBreakTimer"
				  CurrentTimer="GetCountdownTimer"
				  OnSave="CreateOrUpdateSettingsOnSave" />


		<!-- Modals -->
		<SettingsModal @bind-IsOpen="showSettings"
					   DefaultSettings="@defaultSettings"
					   Settings="@userSettings"
					   PomodoroTimer="@pomodoroTimer"
					   ShortBreakTimer="@shortBreakTimer"
					   LongBreakTimer="@longBreakTimer"
					   OnClose="SyncSettingsToDisplay"
					   OnSave="CreateOrUpdateSettingsOnSave" />

		@if (showFinishModal && GetCountdownTimer is not PomodoroTimerDto)
		{
			<TimerFinishModal @bind-IsOpen="showFinishModal"
							  OnClose="@(() => showFinishModal = false)" />
		}
	</div>
</div>

@code
{
	private PomodoroTimerDto pomodoroTimer = new PomodoroTimerDto();
	private ShortBreakTimerDto shortBreakTimer = new ShortBreakTimerDto();
	private LongBreakTimerDto longBreakTimer = new LongBreakTimerDto();
	private int NumberOfPomodorosRun = 0;

	private TaskList? taskListRef;

	private TimerType timerType = Enums.TimerType.Pomodoro;
	private CountdownTimerDto GetCountdownTimer => timerType switch
	{
		TimerType.Pomodoro => pomodoroTimer,
		TimerType.ShortBreak => shortBreakTimer,
		TimerType.LongBreak => longBreakTimer,
		_ => pomodoroTimer
	};

	private string GetBackgroundColor() => timerType switch
	{
		TimerType.Pomodoro => "rgba(227, 18, 10, 1)",     // Red
		TimerType.ShortBreak => "rgba(9, 180, 237, 1)",   // Blue
		TimerType.LongBreak => "rgba(0, 191, 0, 1)",      // Green
		_ => "rgba(227, 18, 10, 1)"
	};

	private bool showFinishModal = false;
	private void OpenSettings() => showSettings = true;

	private ProjectDto defaultProject = new(); // to be expanded with list of projects - each with own tasks and timers
	private UserSettingsDto defaultSettings = new();
	private UserSettingsDto userSettings = new();
	private bool _settingsExist = false;
	private bool showSettings = false;
	private bool showLogin = false;

	protected override async Task OnInitializedAsync()
	{
		timerService.OnTimerUpdate += HandleTimerUpdate;
		timerService.OnTimerFinish += (bool skipped) => HandleTimerFinish(skipped);

		userSettings = await userSettingsApiService.GetAsync();
		_settingsExist = userSettings != null && userSettings.UserSettingsId > 0;
		defaultProject = await userProjectApiService.GetDefaultProjectAsync();

		await SyncSettingsToDisplay();

		if (userSettings?.IsAutoStart == true)
			ToggleStartStopTimer(timerType, GetCountdownTimer);

		// GetCountdownTimer.RemainingTime = GetCountdownTimer.Duration;

		StateHasChanged();
	}

	private async Task SyncSettingsToDisplay()
	{
		var settingsToUse = _settingsExist ? userSettings : defaultSettings;

		if (!GetCountdownTimer.IsRunning)
		{
			pomodoroTimer.Duration = settingsToUse.PomodoroDurationMinutes;
			shortBreakTimer.Duration = settingsToUse.ShortBreakDurationMinutes;
			longBreakTimer.Duration = settingsToUse.LongBreakDurationMinutes;

			pomodoroTimer.RemainingTime = pomodoroTimer.Duration;
			shortBreakTimer.RemainingTime = shortBreakTimer.Duration;
			longBreakTimer.RemainingTime = longBreakTimer.Duration;
		}

		StateHasChanged();
	}

	private async Task CreateOrUpdateSettingsOnSave(UserSettingsDto updatedSettings)
	{
		if (_settingsExist)
		{
			await userSettingsApiService.UpdateAsync(updatedSettings);
		}
		else
		{
			var created = await userSettingsApiService.CreateAsync(updatedSettings);
			if (created != null)
			{
				userSettings = created;
				_settingsExist = true;
			}
		}
	}

	private async Task GetUserSettings()
	{
		userSettings = await userSettingsApiService.GetAsync();
		StateHasChanged();
	}

	private DotNetObjectReference<Index>? objRef;

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			objRef = DotNetObjectReference.Create(this);
			await JS.InvokeVoidAsync("registerGlobalKeyHandler", objRef);
		}
	}

	[JSInvokable]
	public async Task OnSpacePressed()
	{
		ToggleStartStopTimer(timerType, GetCountdownTimer);
		StateHasChanged();
	}

	[JSInvokable]
	public async Task OnTabPressed()
	{
		if (timerType == TimerType.Pomodoro)
			await taskListRef.AddTask();

		StateHasChanged();
	}


	private async void HandleTimerUpdate() => await InvokeAsync(StateHasChanged);

	private void TogglePomodoro() =>
	ToggleStartStopTimer(TimerType.Pomodoro, pomodoroTimer);

	private void ToggleShortBreak() =>
	ToggleStartStopTimer(TimerType.ShortBreak, shortBreakTimer);

	private void ToggleLongBreak() =>
	ToggleStartStopTimer(TimerType.LongBreak, longBreakTimer);

	private async void ToggleStartStopTimer(TimerType type, CountdownTimerDto timer)
	{
		if (timer.IsRunning)
		{
			timerService.Stop(timer);
			// timerFinish = true;
		}
		else
		{
			if (type == TimerType.Pomodoro)
			{
				await taskListRef.SetNextAvailableTaskIfNoneActive();
			}

			timerService.Start(type, timer);
		}

		await JS.InvokeVoidAsync("playClickSound");
	}

	private void SelectAndResetTimer(TimerType timerType, bool userSwitchedTimersUsingTabs = false)
	{
		TimerState.SetTimerType(timerType);

		if (userSwitchedTimersUsingTabs)
			showFinishModal = false;

		this.timerType = timerType;
		timerService.Reset(GetCountdownTimer);

		if (userSettings.IsAutoStart)
			ToggleStartStopTimer(this.timerType, GetCountdownTimer);
	}

	private async void HandleTimerFinish(bool timerWasSkipped = false)
	{
		TimerState.SetTimerType(timerType);

		if (timerWasSkipped)
			showFinishModal = false;
		else
			showFinishModal = true;

		switch (timerType)
		{
			case TimerType.Pomodoro:
				NumberOfPomodorosRun++;
				await IncrementActiveTaskPomodoroCount();

				if (!taskListRef.HasMoreTasks() && taskListRef.ShouldPlaySoundAfterAllTasksDone)
				{
					await JS.InvokeVoidAsync("playTasksDoneSound");
					taskListRef.ShouldPlaySoundAfterAllTasksDone = false;
				}
				else if (!timerWasSkipped)
				{
					await JS.InvokeVoidAsync("playAlarmSound");
					await JS.InvokeVoidAsync("showNotification",
						"Pomodoro Finished!",
						NumberOfPomodorosRun >= userSettings.RunsBeforeLongBreak
							? $"Time for a long break ({(int)longBreakTimer.Duration.TotalMinutes} min)"
							: $"Take a short break ({(int)shortBreakTimer.Duration.TotalMinutes} min)");
				}

				if (NumberOfPomodorosRun >= userSettings.RunsBeforeLongBreak)
				{
					SelectAndResetTimer(TimerType.LongBreak);
					NumberOfPomodorosRun = 0;
				}
				else
				{
					SelectAndResetTimer(TimerType.ShortBreak);
				}
				break;

			case TimerType.ShortBreak:
				if (!timerWasSkipped)
				{
					await JS.InvokeVoidAsync("playBreakOverSound");
					await JS.InvokeVoidAsync("showNotification",
						"Short Break Over!",
						$"Current task is{": " + taskListRef.ActiveTask?.Name ?? " not set"}");
				}
				SelectAndResetTimer(TimerType.Pomodoro);
				break;

			case TimerType.LongBreak:
				if (!timerWasSkipped)
				{
					await JS.InvokeVoidAsync("playBreakOverSound");
					await JS.InvokeVoidAsync("showNotification",
						"Long Break Over!",
						$"Current task is{": " + taskListRef.ActiveTask?.Name ?? " not set"}");
				}

				SelectAndResetTimer(TimerType.Pomodoro);
				break;
		}
	}


	private void RestartTimer(CountdownTimerDto timer)
	{
		timerService.Reset(timer);

		if (userSettings.IsAutoStartAfterRestart) ToggleStartStopTimer(timerType, GetCountdownTimer);
	}

	private async Task IncrementActiveTaskPomodoroCount()
	{
		if (taskListRef != null)
			await taskListRef.IncrementActivePomodoroCount();
	}

	private void ResetPomodoroCount() => NumberOfPomodorosRun = 0;

	private void AddTimeToTimer()
	{
		bool DoesAddedTimeExceedMaxDuration = GetCountdownTimer.RemainingTime + TimeSpan.FromMinutes(1) > GetCountdownTimer.Duration;

		if (!DoesAddedTimeExceedMaxDuration) GetCountdownTimer.RemainingTime = GetCountdownTimer.RemainingTime.Add(TimeSpan.FromMinutes(1));
	}

	public void Dispose()
	{
		timerService.OnTimerUpdate -= HandleTimerUpdate;
		timerService.OnTimerFinish -= HandleTimerFinish;
		objRef?.Dispose();
	}
}
