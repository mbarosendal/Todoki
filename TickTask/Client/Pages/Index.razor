@page "/"
@using TickTask.Client.Enums
@using TickTask.Client.Services
@using TickTask.Client.Components
@using TickTask.Shared
@inject TimerService timerService
@inject TaskService taskService
@inject IJSRuntime JS
@inject ILogger<Index> Logger
@implements IDisposable

<PageTitle>TickTask</PageTitle>

<h1>Welcome to TickTask ✔️</h1>

<div>
	<!-- Timer Tabs -->
	<div>
		@foreach (TimerType type in Enum.GetValues<TimerType>())
		{
			<button @onclick="() => SelectAndResetTimer(type)"
			style="background-color: @(timerType == type ? "darkgreen" : "green")">
				@type
			</button>
		}
	</div>

	<!-- Settings Menu -->
	<button @onclick="OpenSettings">Open Settings</button>
	<SettingsModal @bind-IsOpen="showSettings" Settings="@settings" PomodoroTimer="@pomodoroTimer" ShortBreakTimer="@shortBreakTimer" LongBreakTimer="@longBreakTimer" />

	<!-- TimerFinishModal -->
	<TimerFinishModal @bind-IsOpen="isTimerFinished" CountdownTimer="@countdownTimer" />

	<!-- Timer Display -->
	<div>
		<h1>@countdownTimer.RemainingTime.ToString(@"mm\:ss")</h1>
		<h3>@($"{settings.NumberOfPomodorosRun} / {settings.RunsBeforeLongBreak}")</h3>
	</div>

	<!-- Timer Control Buttons -->
	<div>
		<button @onclick="() => ToggleStartStopTimer(timerType, countdownTimer)" style="background-color: red">@(countdownTimer.IsRunning ? "Stop" : "Start")</button>
		<button @onclick="() => RestartTimer(countdownTimer)" style="background-color: red">Restart</button>
		<button @onclick="() => ResetPomodoroCount()">Reset </button>
		<button @onclick="() => HandleTimerFinish(timerWasSkipped : true)">Skip</button>
		<button @onclick="() => AddTimeToTimer()">+1</button>
	</div>

	<!-- Tasks Separator -->
	<!-- Task List Component -->
	<TaskList />

</div>

@code
{
	private CountdownTimer pomodoroTimer = new PomodoroTimer();
	private CountdownTimer shortBreakTimer = new ShortBreakTimer();
	private CountdownTimer longBreakTimer = new LongBreakTimer();

	private TimerType timerType = Enums.TimerType.Pomodoro;
	private CountdownTimer countdownTimer => timerType switch
	{
		TimerType.Pomodoro => pomodoroTimer,
		TimerType.ShortBreak => shortBreakTimer,
		TimerType.LongBreak => longBreakTimer,
		_ => pomodoroTimer
	};

	private bool isTimerFinished = false;

	private TimerSettings settings = new();
	private bool showSettings = false;
	private void OpenSettings() => showSettings = true;

	protected override void OnInitialized()
	{
		timerService.OnTimerUpdate += HandleTimerUpdate;
		timerService.OnTimerFinish += (bool skipped) => HandleTimerFinish(skipped);

		if (settings.IsAutoStart) ToggleStartStopTimer(timerType, countdownTimer);

		countdownTimer.RemainingTime = countdownTimer.Duration;
	}

	private async void HandleTimerUpdate() => await InvokeAsync(StateHasChanged);

	private void TogglePomodoro() =>
		ToggleStartStopTimer(TimerType.Pomodoro, pomodoroTimer);

	private void ToggleShortBreak() =>
		ToggleStartStopTimer(TimerType.ShortBreak, shortBreakTimer);

	private void ToggleLongBreak() =>
		ToggleStartStopTimer(TimerType.LongBreak, longBreakTimer);

	private async void ToggleStartStopTimer(TimerType type, CountdownTimer timer)
	{
		if (timer.IsRunning)
		{
			timerService.Stop(timer);
			// timerFinish = true;
		}
		else
		{
			timerService.Start(type, timer);
		}

		await JS.InvokeVoidAsync("playClickSound");
	}

	private void SelectAndResetTimer(TimerType type)
	{
		timerType = type;
		timerService.Reset(countdownTimer);

		if (settings.IsAutoStart) ToggleStartStopTimer(timerType, countdownTimer);
	}

	private async void HandleTimerFinish(bool timerWasSkipped = false)
	{
		isTimerFinished = true;

		switch (timerType)
		{
			case TimerType.Pomodoro:
				settings.NumberOfPomodorosRun++;

				if (!timerWasSkipped)
					await JS.InvokeVoidAsync("playAlarmSound");

				if (settings.NumberOfPomodorosRun >= settings.RunsBeforeLongBreak)
				{
					SelectAndResetTimer(TimerType.LongBreak);
					settings.NumberOfPomodorosRun = 0;
				}
				else
				{
					SelectAndResetTimer(TimerType.ShortBreak);
				}
				break;

			case TimerType.ShortBreak:
			case TimerType.LongBreak:
				SelectAndResetTimer(TimerType.Pomodoro);
				break;
		}
	}

	private void RestartTimer(CountdownTimer timer)
	{
		timerService.Reset(timer);

		if (settings.IsAutoStartAfterRestart) ToggleStartStopTimer(timerType, countdownTimer);
	}

	private void ResetPomodoroCount() => settings.NumberOfPomodorosRun = 0;

	private void AddTimeToTimer()
	{
		bool isMoreThanDuration = countdownTimer.RemainingTime + TimeSpan.FromMinutes(1) > countdownTimer.Duration;

		if (!isMoreThanDuration) countdownTimer.RemainingTime = countdownTimer.RemainingTime.Add(TimeSpan.FromMinutes(1));
	}

	public void Dispose()
	{
		timerService.OnTimerUpdate -= HandleTimerUpdate;
		timerService.OnTimerFinish -= HandleTimerFinish;
	}
}