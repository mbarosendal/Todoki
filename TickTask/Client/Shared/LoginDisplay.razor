@using Blazored.LocalStorage
@inject AuthenticationStateProvider AuthStateProvider
@inject ILocalStorageService LocalStorage
@inject NavigationManager Nav
@inject HttpClientWrapper Http
@inject ILogger<LoginDisplay> _logger

<AuthorizeView>
    <Authorized>
        @if (!context.User.IsInRole("Admin") && !context.User.IsInRole("User"))
        {
            <div class="tooltip-btn">
                <!-- Eye / Guest Icon SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="red" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shield-alert-icon lucide-shield-alert"><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z" /><path d="M12 8v4" /><path d="M12 16h.01" /></svg>

                <!-- Tooltip text -->
                <div class="tooltip-text">
                    Welcome guest! Please be aware that changes to your settings are not persisted (resets on refresh).<br />
                    Tasks for guest profiles are also automatically cleaned after 30 days of inactivity.<br />
                    However, feel free to make an account and everything will be persisted without a time limit.
                </div>
            </div>
        }
    </Authorized>
</AuthorizeView>


<span class="user-label">@UserLabel</span>
<button class="auth-btn" @onclick="RequestLogin" hidden="@IsAuthenticated">Login 
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-in-icon lucide-log-in"><path d="m10 17 5-5-5-5" /><path d="M15 12H3" /><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4" /></svg>
</button>
<button class="auth-btn" @onclick="Logout" hidden="@( !IsAuthenticated )">Logout 
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out-icon lucide-log-out"><path d="m16 17 5-5-5-5" /><path d="M21 12H9" /><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /></svg>
</button>

@code {
    [Parameter] public EventCallback OnLoginRequested { get; set; }

    private bool IsAuthenticated;
    private string UserLabel = "Guest";

    protected override async Task OnInitializedAsync()
    {
        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = state.User;
        IsAuthenticated = user.Identity?.IsAuthenticated ?? false;
        if (IsAuthenticated)
        {
            UserLabel = user.Identity?.Name ?? user.FindFirst(c => c.Type == "email")?.Value ?? "User";
        }
    }

    private async Task RequestLogin()
    {
        await OnLoginRequested.InvokeAsync();
    }

    private async Task Logout()
    {
        _logger.LogInformation("Attempting to log out...");
        var refreshToken = await LocalStorage.GetItemAsync<string>("refreshToken");
        if (!string.IsNullOrEmpty(refreshToken))
        {
            _logger.LogInformation("Found refresh token, calling logout endpoint...");
            var response = await Http.PostAsJsonAsync("api/authentication/logout", new { RefreshToken = refreshToken });
            Nav.NavigateTo("/", forceLoad: true);
            if (response.IsSuccessStatusCode)
            {
                _logger.LogInformation("Logout success, clearing tokens...");
                await LocalStorage.RemoveItemAsync("authToken");
                await LocalStorage.RemoveItemAsync("refreshToken");
            }
            else
            {
                _logger.LogWarning("Logout HTTP failed: " + response.StatusCode);
            }
        }
        else
        {
            _logger.LogInformation("No refresh token found, just clearing local JWT");
            await LocalStorage.RemoveItemAsync("authToken");
        }

        if (AuthStateProvider is JwtAuthenticationStateProvider jwtAuth)
        {
            jwtAuth.MarkUserAsLoggedOut();
        }
        IsAuthenticated = false;
        Nav.NavigateTo("/");
    }
}

<style>
    .user-label {
        margin-right: 8px;
        font-size: 0.9rem;
        color: white;
    }

    .auth-btn {
        background-color: rgb(10, 137, 18);
        color: white;
        border: none;
        padding: 8px 16px;
        font-size: 0.95rem;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
        margin: 0 4px;
    }

        .auth-btn:hover {
            background-color: #3ab231;
            transform: translateY(-1px);
        }

        .auth-btn:active {
            transform: translateY(0);
        }
</style>